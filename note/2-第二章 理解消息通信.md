## 第二章 理解消息通信

生产者（producer）创建消息，然后发布（发送）到代理服务器（RabbitMQ）。消息包含两部分内容：有效载荷（payload）和标签（label）。有效载荷就是想要传输的数据。它可以是任何内容，一个JSON 数组或者是MPEG-4等。RabbitMQ不会在意这些。标签则描述了有效载荷，并且RabbitMQ 用它来决定谁将获得消息的拷贝。

消费者（consumer）连接到代理服务器，并订阅到队列（queue）上。把消息队列想象成一个具体邮箱。每当消息到达特定的邮箱是，RabbitMQ会将其发生给其中一个订阅的/监听的消费者。当消费者接收到消息时，它只得到消息的一部分：有效载荷。

信道（channel）：必须首先连接到Rabbit，才能消费或者发布消息。你的应用程序和Rabbit代理服务器之间创建一条 TCP 连接。一旦TCP连接打开（通过了认证），应用程序就可以创建一条AMQP channel。channel是建立在 “真实的” TCP 连接内的虚拟连接。AMQP命令都是通过channel发送出去的。每条channel都会被指派一个唯一 ID 。对于操作系统来说建立和销毁 TCP 会话是非常昂贵的开销。

<div>
    <image src="../img/channel.png" height="120"></image>
</div>

### 队列

AMQP消息路由必须有三部分：Exchange、Queue和Binding。生产者把消息发布到交换机上；消息最终到达队列，并被消费者接收；绑定决定了消息如何从路由器路由到特定的队列.

<div>
    <image src="../img/queue.png" height="380"></image>
</div>

Queue如同邮箱，消息最终到达队列并等待消费。消费者通过以下两种方式从特定的队列中接收消息：

1. 通过AMQP的 basic.consume 命令订阅。这样会将channel置为接收模式，指导取消对队列的订阅为止。订阅了消息后，消费者在消费（或者拒绝）最近接收的那条消息后，就能从队列中（可用的）自动接收下一条消息。如果消费者处理队列消息，并且需要在消息一到达队列时就自动接收的话，应该使用此方式。
2.  某些时候，你只想从队列获得单条消息而不是持续订阅。向队列请求单条消息是通过AMQP 的 basic.get 命令实现的。这样做可以让消费者接收队列中的下一条消息。如果要获得更多消息的哈，需要再次发送 basic.get 命令。注意：你不应该将 basic.get 放在一个循环里来替代 basic.consum。因为这样会影响Rabbit性能。

当队列中有多个消费者时，队列收到的消息将以循环（round-robin）的方式发送给消费者。